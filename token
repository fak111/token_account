#!/usr/bin/env python3
"""token - Count LLM tokens for files
Usage: token [options] <file>...
"""

import sys
import argparse
from pathlib import Path

# 自动安装 tiktoken（如果没有）
try:
    import tiktoken
except ImportError:
    import subprocess
    import os
    devnull = open(os.devnull, 'w')
    # Try --user first, fall back to --break-system-packages for externally-managed envs
    try:
        subprocess.check_call([sys.executable, "-m", "pip", "install", "-q", "--user", "tiktoken"], stderr=devnull)
    except subprocess.CalledProcessError:
        subprocess.check_call([sys.executable, "-m", "pip", "install", "-q", "--break-system-packages", "tiktoken"], stderr=devnull)
    devnull.close()
    import tiktoken

def count_tokens(text: str, model: str = "gpt-4o") -> int:
    enc = tiktoken.encoding_for_model(model)
    return len(enc.encode(text))

def count_file(path: Path, model: str) -> tuple[str, int]:
    try:
        text = path.read_text(encoding="utf-8")
        return str(path), count_tokens(text, model)
    except Exception as e:
        return str(path), -1

def main():
    parser = argparse.ArgumentParser(description="Count LLM tokens")
    parser.add_argument("files", nargs="*", type=Path, help="Files to count")
    parser.add_argument("-m", "--model", default="gpt-4o", help="Model (default: gpt-4o)")
    parser.add_argument("-v", "--verbose", action="store_true", help="Verbose output")
    parser.add_argument("--json", action="store_true", dest="json_out", help="JSON output")
    args = parser.parse_args()

    results = []

    # stdin 模式
    if not args.files and not sys.stdin.isatty():
        text = sys.stdin.read()
        tokens = count_tokens(text, args.model)
        print(tokens)
        return

    if not args.files:
        parser.print_help()
        sys.exit(1)

    # 文件模式
    for f in args.files:
        if f.is_dir():
            for p in f.rglob("*"):
                if p.is_file() and not p.name.startswith("."):
                    results.append(count_file(p, args.model))
        elif f.exists():
            results.append(count_file(f, args.model))
        else:
            print(f"Error: {f} not found", file=sys.stderr)
            sys.exit(1)

    total = sum(t for _, t in results if t >= 0)

    # 输出
    if args.json_out:
        import json
        print(json.dumps({
            "files": [{"path": p, "tokens": t} for p, t in results],
            "total": total
        }, ensure_ascii=False))
    elif args.verbose or len(results) > 1:
        max_len = max(len(p) for p, _ in results)
        for p, t in results:
            print(f"{p:<{max_len}}  {t:>8}")
        if len(results) > 1:
            print("-" * (max_len + 10))
            print(f"{'Total':<{max_len}}  {total:>8}")
    else:
        print(total)

if __name__ == "__main__":
    main()
